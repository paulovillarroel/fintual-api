---
title: "An√°lisis Fintual - Valor Cuota y Riesgo"
subtitle: "Fondo Risky Norris"
author: "Paulo Villarroel"
date: "`r Sys.Date()`"
lang: es
format: 
  html:
    theme: cosmo
    toc: true
    toc-depth: 3
    code-fold: true
    fig-width: 10
    fig-height: 6
    embed-resources: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r libraries}
library(ggplot2)
library(dplyr)
library(scales)
library(lubridate)
library(gridExtra)
library(knitr)
library(purrr)
```

```{r load-data}
# Cargar datos desde archivo externo
source("api-req.R")

# Verificar que los datos se cargaron correctamente
if (!exists("df") || !is.data.frame(df)) {
  stop("Error: No se pudo cargar el dataframe 'df' desde api-req.R")
}

cat(
  "Per√≠odo de an√°lisis:",
  format(as.Date(start_date), "%d/%m/%Y"),
  "al",
  format(as.Date(end_date), "%d/%m/%Y"),
  "\n"
)
```

## Resumen Ejecutivo

Este an√°lisis examina la evoluci√≥n del valor cuota del **Fondo Risky Norris** de Fintual durante el per√≠odo analizado, evaluando su rendimiento, volatilidad y comportamiento como instrumento de alto riesgo.

**CONTEXTO DEL AN√ÅLISIS:** Este reporte analiza un fondo de inversi√≥n de alto riesgo durante `r as.numeric(as.Date(end_date) - as.Date(start_date))` d√≠as, incluyendo m√©tricas de rendimiento, volatilidad y evaluaci√≥n de riesgo para generar recomendaciones de inversi√≥n.

```{r data-prep}
# Calcular m√©tricas de an√°lisis
df_analysis <- df %>%
  arrange(date) %>%
  mutate(
    # Retornos diarios
    daily_return = (price - lag(price)) / lag(price) * 100,
    # Retorno acumulado
    cumulative_return = (price / first(price) - 1) * 100,
    # Media m√≥vil 7 d√≠as
    ma_7 = zoo::rollmean(price, k = 7, fill = NA, align = "right"),
    # Media m√≥vil 30 d√≠as
    ma_30 = zoo::rollmean(price, k = 30, fill = NA, align = "right"),
    # Volatilidad m√≥vil (7 d√≠as)
    volatility_7d = zoo::rollapply(
      daily_return,
      7,
      sd,
      fill = NA,
      align = "right",
      na.rm = TRUE
    )
  )

# M√©tricas clave
start_price <- first(df_analysis$price, na_rm = TRUE)
end_price <- last(df_analysis$price, na_rm = TRUE)
total_return <- (end_price / start_price - 1) * 100
avg_daily_return <- mean(df_analysis$daily_return, na.rm = TRUE)
volatility <- sd(df_analysis$daily_return, na.rm = TRUE)
sharpe_approx <- avg_daily_return / volatility * sqrt(252)
max_price <- max(df_analysis$price, na_rm = TRUE)
min_price <- min(df_analysis$price, na_rm = TRUE)
max_drawdown <- min(df_analysis$cumulative_return, na.rm = TRUE)
current_annual_vol <- volatility * sqrt(252)

# An√°lisis de tendencia
lm_model <- lm(price ~ as.numeric(date), data = df_analysis)
slope_daily <- coef(lm_model)[2]
slope_monthly <- slope_daily * 30
trend_direction <- ifelse(slope_daily > 0, "ALCISTA", "BAJISTA")

# An√°lisis de volatilidad por per√≠odos
vol_periods <- df_analysis %>%
  mutate(month = floor_date(date, "month")) %>%
  group_by(month) %>%
  summarise(
    monthly_vol = sd(daily_return, na.rm = TRUE),
    monthly_return = (last(price) / first(price) - 1) * 100,
    .groups = "drop"
  )

avg_monthly_vol <- mean(vol_periods$monthly_vol, na.rm = TRUE)

# D√≠as con movimientos significativos
significant_moves <- df_analysis %>%
  filter(abs(daily_return) > 2) %>%
  nrow()
```

## Datos Estructurados para An√°lisis - M√©tricas Principales

```{r metrics-for-ai}
# Crear estructura de datos para IA
ai_metrics <- list(
  # Informaci√≥n b√°sica
  basic_info = list(
    fund_name = "Risky Norris",
    fund_id = 188,
    analysis_period_days = as.numeric(as.Date(end_date) - as.Date(start_date)),
    start_date = start_date,
    end_date = end_date,
    total_observations = nrow(df_analysis)
  ),

  # M√©tricas de rendimiento
  performance = list(
    start_price_clp = round(start_price, 2),
    end_price_clp = round(end_price, 2),
    total_return_percent = round(total_return, 3),
    avg_daily_return_percent = round(avg_daily_return, 4),
    best_day_return = round(max(df_analysis$daily_return, na.rm = TRUE), 2),
    worst_day_return = round(min(df_analysis$daily_return, na.rm = TRUE), 2),
    positive_days = sum(df_analysis$daily_return > 0, na.rm = TRUE),
    negative_days = sum(df_analysis$daily_return < 0, na.rm = TRUE),
    neutral_days = sum(df_analysis$daily_return == 0, na.rm = TRUE)
  ),

  # M√©tricas de riesgo
  risk = list(
    daily_volatility_percent = round(volatility, 4),
    annualized_volatility_percent = round(current_annual_vol, 2),
    max_drawdown_percent = round(max_drawdown, 2),
    sharpe_ratio_approx = round(sharpe_approx, 3),
    days_with_significant_moves = significant_moves,
    significant_moves_frequency_percent = round(
      significant_moves / nrow(df_analysis) * 100,
      2
    )
  ),

  # An√°lisis de tendencia
  trend = list(
    overall_direction = trend_direction,
    daily_price_change_clp = round(slope_daily, 4),
    monthly_price_change_clp = round(slope_monthly, 2),
    price_range_min_clp = round(min_price, 2),
    price_range_max_clp = round(max_price, 2),
    price_range_amplitude_percent = round(
      (max_price - min_price) / min_price * 100,
      2
    )
  )
)
```
```{r metrics, echo=FALSE}
# Mostrar m√©tricas estructuradas para an√°lisis por IA
cat("üìä INFORMACI√ìN B√ÅSICA:\n")
cat("- Fondo:", ai_metrics$basic_info$fund_name, "\n")
cat("- ID Fondo:", ai_metrics$basic_info$fund_id, "\n")
cat("- Per√≠odo:", ai_metrics$basic_info$analysis_period_days, "d√≠as\n")
cat("- Observaciones:", ai_metrics$basic_info$total_observations, "\n\n")

cat("üìà RENDIMIENTO:\n")
cat("- Retorno total:", ai_metrics$performance$total_return_percent, "%\n")
cat(
  "- Retorno diario promedio:",
  ai_metrics$performance$avg_daily_return_percent,
  "%\n"
)
cat("- Mejor d√≠a:", ai_metrics$performance$best_day_return, "%\n")
cat("- Peor d√≠a:", ai_metrics$performance$worst_day_return, "%\n")
cat(
  "- D√≠as positivos:",
  ai_metrics$performance$positive_days,
  "| D√≠as negativos:",
  ai_metrics$performance$negative_days,
  "\n\n"
)

cat("‚ö†Ô∏è RIESGO:\n")
cat("- Volatilidad diaria:", ai_metrics$risk$daily_volatility_percent, "%\n")
cat(
  "- Volatilidad anualizada:",
  ai_metrics$risk$annualized_volatility_percent,
  "%\n"
)
cat("- M√°ximo drawdown:", ai_metrics$risk$max_drawdown_percent, "%\n")
cat("- Ratio Sharpe aproximado:", ai_metrics$risk$sharpe_ratio_approx, "\n")
cat(
  "- Movimientos significativos:",
  ai_metrics$risk$significant_moves_frequency_percent,
  "% de los d√≠as\n\n"
)

cat("üìä TENDENCIA:\n")
cat("- Direcci√≥n general:", ai_metrics$trend$overall_direction, "\n")
cat(
  "- Cambio diario promedio:",
  ai_metrics$trend$daily_price_change_clp,
  "CLP\n"
)
cat(
  "- Cambio mensual promedio:",
  ai_metrics$trend$monthly_price_change_clp,
  "CLP\n"
)
cat(
  "- Rango de precios:",
  ai_metrics$trend$price_range_min_clp,
  "-",
  ai_metrics$trend$price_range_max_clp,
  "CLP\n"
)
cat(
  "- Amplitud del rango:",
  ai_metrics$trend$price_range_amplitude_percent,
  "%\n"
)
```

## 1. Evoluci√≥n del Valor Cuota

**DESCRIPCI√ìN PARA IA:** Este gr√°fico muestra la evoluci√≥n temporal del precio del fondo Risky Norris con medias m√≥viles de 7 y 30 d√≠as, m√°s una l√≠nea de tendencia general. Permite identificar patrones, tendencias y puntos de inflexi√≥n importantes en el per√≠odo analizado.

```{r price-evolution, fig.cap="GR√ÅFICO PRINCIPAL: Evoluci√≥n del valor cuota con indicadores t√©cnicos. L√≠nea azul = precio diario, l√≠nea rosada = media m√≥vil 7 d√≠as, l√≠nea naranja = media m√≥vil 30 d√≠as, l√≠nea roja = tendencia general"}
ggplot(df_analysis, aes(x = date, y = price)) +
  geom_line(color = "#2E86AB", size = 1.2, alpha = 0.8) +
  geom_line(
    aes(y = ma_7),
    color = "#A23B72",
    size = 0.8,
    alpha = 0.7,
    linetype = "dashed"
  ) +
  geom_line(
    aes(y = ma_30),
    color = "#F18F01",
    size = 0.8,
    alpha = 0.7,
    linetype = "dotted"
  ) +
  geom_smooth(
    method = "lm",
    color = "#C73E1D",
    size = 0.8,
    alpha = 0.3,
    se = TRUE
  ) +
  scale_y_continuous(labels = scales::comma_format()) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b %Y") +
  labs(
    title = "Evoluci√≥n del Valor Cuota - Fondo Risky Norris",
    subtitle = paste0(
      "Per√≠odo: ",
      format(as.Date(start_date), "%d/%m/%Y"),
      " - ",
      format(as.Date(end_date), "%d/%m/%Y")
    ),
    x = "Fecha",
    y = "Valor Cuota (CLP)",
    caption = "L√≠neas: Precio (azul), MA 7 d√≠as (rosado), MA 30 d√≠as (naranja), Tendencia (rojo)"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12),
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid.minor = element_blank()
  )
```

## 2. An√°lisis de Retornos

### 2.1 Retornos Diarios

**DESCRIPCI√ìN PARA IA:** Gr√°fico de barras que muestra los retornos diarios del fondo. Barras verdes indican d√≠as con retornos positivos, barras rojas d√≠as con retornos negativos. Permite identificar volatilidad, clusters de volatilidad y d√≠as con movimientos excepcionales.

```{r daily-returns, fig.cap="RETORNOS DIARIOS: Barras verdes = d√≠as positivos, barras rojas = d√≠as negativos. Permite identificar per√≠odos de alta volatilidad y movimientos excepcionales"}
ggplot(df_analysis, aes(x = date, y = daily_return)) +
  geom_hline(yintercept = 0, color = "gray50", linetype = "dashed") +
  geom_col(aes(fill = daily_return > 0), alpha = 0.7) +
  scale_fill_manual(values = c("TRUE" = "#27AE60", "FALSE" = "#E74C3C")) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b %Y") +
  labs(
    title = "Retornos Diarios - Fondo Risky Norris",
    x = "Fecha",
    y = "Retorno Diario (%)"
  ) +
  theme_minimal() +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid.minor = element_blank()
  )
```

### 2.2 Retorno Acumulado

**DESCRIPCI√ìN PARA IA:** Muestra la evoluci√≥n del retorno acumulado del fondo desde el inicio del per√≠odo. Permite evaluar la performance total y identificar per√≠odos de ganancia o p√©rdida sostenida.

```{r cumulative-returns, fig.cap="RETORNO ACUMULADO: Evoluci√≥n de la performance total del fondo desde el inicio del per√≠odo de an√°lisis"}
ggplot(df_analysis, aes(x = date, y = cumulative_return)) +
  geom_hline(yintercept = 0, color = "gray50", linetype = "dashed") +
  geom_line(color = "#8E44AD", size = 1.2) +
  geom_area(alpha = 0.2, fill = "#8E44AD") +
  scale_x_date(date_breaks = "1 month", date_labels = "%b %Y") +
  labs(
    title = "Retorno Acumulado - Fondo Risky Norris",
    x = "Fecha",
    y = "Retorno Acumulado (%)"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid.minor = element_blank()
  )
```

## 3. An√°lisis de Volatilidad

### 3.1 Distribuci√≥n de Retornos

**DESCRIPCI√ìN PARA IA:** Histograma que muestra la distribuci√≥n de los retornos diarios. La l√≠nea naranja indica la media de retornos. Permite evaluar la simetr√≠a de la distribuci√≥n, identificar sesgos y evaluar la normalidad de los retornos.

```{r returns-distribution, fig.cap="DISTRIBUCI√ìN DE RETORNOS: Histograma de retornos diarios. L√≠nea naranja = media. Permite evaluar simetr√≠a, sesgos y normalidad de los retornos"}
ggplot(df_analysis, aes(x = daily_return)) +
  geom_histogram(bins = 30, fill = "#34495E", alpha = 0.7, color = "white") +
  geom_vline(
    xintercept = avg_daily_return,
    color = "#E67E22",
    size = 1,
    linetype = "dashed"
  ) +
  geom_vline(xintercept = 0, color = "gray50", linetype = "dashed") +
  labs(
    title = "Distribuci√≥n de Retornos Diarios - Fondo Risky Norris",
    x = "Retorno Diario (%)",
    y = "Frecuencia",
    caption = "L√≠nea naranja: Media de retornos"
  ) +
  theme_minimal()
```

### 3.2 Volatilidad M√≥vil

**DESCRIPCI√ìN PARA IA:** Muestra la evoluci√≥n de la volatilidad m√≥vil de 7 d√≠as a lo largo del tiempo. Permite identificar per√≠odos de alta y baja volatilidad, y tendencias en el riesgo del fondo.

```{r volatility-evolution, fig.cap="VOLATILIDAD M√ìVIL: Evoluci√≥n de la volatilidad de 7 d√≠as. Identifica per√≠odos de alta/baja volatilidad y tendencias en el riesgo"}
ggplot(df_analysis, aes(x = date, y = volatility_7d)) +
  geom_line(color = "#E74C3C", size = 1) +
  geom_smooth(method = "loess", color = "#3498DB", alpha = 0.3) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b %Y") +
  labs(
    title = "Volatilidad M√≥vil (7 d√≠as) - Fondo Risky Norris",
    x = "Fecha",
    y = "Volatilidad (%)"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid.minor = element_blank()
  )
```

## 4. M√©tricas Clave

```{r metrics-table}
# Crear tabla de m√©tricas
metrics_table <- data.frame(
  M√©trica = c(
    "Valor Inicial (CLP)",
    "Valor Final (CLP)",
    "Retorno Total (%)",
    "Retorno Promedio Diario (%)",
    "Volatilidad Diaria (%)",
    "Volatilidad Anualizada (%)",
    "Ratio Sharpe Aproximado",
    "M√°ximo Drawdown (%)",
    "Tendencia General",
    "Cambio Promedio Mensual (CLP)",
    "D√≠as con Movimientos >2%",
    "Mejor D√≠a (%)",
    "Peor D√≠a (%)"
  ),
  Valor = c(
    format(round(start_price), big.mark = ","),
    format(round(end_price), big.mark = ","),
    sprintf("%.2f", total_return),
    sprintf("%.3f", avg_daily_return),
    sprintf("%.3f", volatility),
    sprintf("%.2f", current_annual_vol),
    sprintf("%.2f", sharpe_approx),
    sprintf("%.2f", max_drawdown),
    trend_direction,
    sprintf("%.2f", slope_monthly),
    sprintf(
      "%d de %d (%.1f%%)",
      significant_moves,
      nrow(df_analysis),
      significant_moves / nrow(df_analysis) * 100
    ),
    sprintf("%.2f", max(df_analysis$daily_return, na.rm = TRUE)),
    sprintf("%.2f", min(df_analysis$daily_return, na.rm = TRUE))
  )
)

kable(
  metrics_table,
  caption = "Resumen de M√©tricas Principales - Fondo Risky Norris",
  align = c("l", "r")
)
```

## 5. Evaluaci√≥n de Riesgo

```{r risk-assessment}
# Evaluaci√≥n de riesgo basada en volatilidad
risk_description <- case_when(
  current_annual_vol < 15 ~ "BAJA",
  current_annual_vol < 25 ~ "MODERADA-ALTA",
  current_annual_vol < 35 ~ "ALTA",
  TRUE ~ "MUY ALTA"
)

# Crear tabla de evaluaci√≥n de riesgo
risk_table <- data.frame(
  Aspecto = c(
    "Volatilidad Anualizada (%)",
    "Clasificaci√≥n de Volatilidad",
    "D√≠as con Movimientos Significativos",
    "Frecuencia de Alta Volatilidad",
    "Ratio Sharpe",
    "Drawdown M√°ximo (%)"
  ),
  Resultado = c(
    sprintf("%.1f", current_annual_vol),
    risk_description,
    sprintf("%.1f%% del per√≠odo", significant_moves / nrow(df_analysis) * 100),
    ifelse(
      current_annual_vol > 25,
      "ALTA",
      ifelse(current_annual_vol > 15, "MODERADA", "BAJA")
    ),
    sprintf("%.2f", sharpe_approx),
    sprintf("%.2f", abs(max_drawdown))
  )
)

kable(
  risk_table,
  caption = "Evaluaci√≥n de Riesgo del Fondo Risky Norris",
  align = c("l", "l")
)
```

## 6. An√°lisis Mensual

```{r monthly-analysis}
# Crear tabla de an√°lisis mensual
monthly_summary <- vol_periods %>%
  mutate(
    month_name = format(month, "%b %Y"),
    monthly_vol = round(monthly_vol, 2),
    monthly_return = round(monthly_return, 2)
  ) %>%
  select(
    Mes = month_name,
    `Retorno Mensual (%)` = monthly_return,
    `Volatilidad Mensual (%)` = monthly_vol
  )

kable(
  monthly_summary,
  caption = "An√°lisis de Performance Mensual - Fondo Risky Norris",
  align = c("l", "r", "r")
)
```

## 7. Conclusiones para An√°lisis

### Resumen de Performance
- **Retorno Total**: `r sprintf("%.2f%%", total_return)`
- **Tendencia General**: **`r trend_direction`**
- **Volatilidad**: `r sprintf("%.1f%%", current_annual_vol)` anualizada (**`r risk_description`**)

### Caracter√≠sticas de Riesgo
- **Ratio Sharpe**: `r sprintf("%.2f", sharpe_approx)` (indica `r ifelse(sharpe_approx > 1, "buena", ifelse(sharpe_approx > 0.5, "moderada", "baja"))` relaci√≥n riesgo-retorno)
- **Drawdown M√°ximo**: `r sprintf("%.2f%%", abs(max_drawdown))`
- **D√≠as Vol√°tiles**: `r sprintf("%.1f%%", significant_moves/nrow(df_analysis)*100)` del per√≠odo

### Perfil del Fondo
El **Fundo Risky Norris** muestra caracter√≠sticas de `r ifelse(current_annual_vol > 25, "alto riesgo", ifelse(current_annual_vol > 15, "riesgo moderado-alto", "riesgo moderado"))` con una volatilidad anualizada de `r sprintf("%.1f%%", current_annual_vol)`.

---

*An√°lisis generado el `r format(Sys.Date(), "%d de %B de %Y")` por Paulo Villarroel*